# Debugging Log - 05 February 2026
**Timestamp:** 22:01 GMT

## Objective
Align Vercel production deployment with local development server performance and resolve the "reversion" issue where Deep Intelligence components fail to display alongside the Brand Radar.

## 1. Backend & API Fixes
- **Model Standardisation**: Reverted all Perplexity Sonar calls to `sonar-pro` (from `sonar`) to ensure consistency and access to deeper reasoning.
- **Gemini Alignment**: Synchronised the Vercel utility (`api/_utils.js`) with the local server (`local-api-server.js`).
    - Switched from `@google/genai` to `@google/generative-ai` SDK.
    - Forced model to `gemini-3-flash-preview`.
    - Explicitly enabled `googleSearch` grounding tools.
- **API Key Validation**: Resolved a critical issue where environment variables contained leading/trailing whitespace, causing "Invalid API Key" errors.

## 2. Frontend & State Management Fixes
- **Persistence Strategy**: Implemented global state persistence for `intelligenceReports` in `useAnalysis.tsx`.
- **Guest Access Fix**: Updated hooks to allow anonymous (non-logged-in) users to load persisted intelligence data from `localStorage`.
- **Key Normalisation**: Introduced `.trim()` to company name keys to prevent mismatches between AI-generated strings and storage identifiers.
- **Simultaneous Triggering**: Modified `addCompetitorByName` to trigger both Brand Radar and Deep Intelligence analysis in parallel.

## 3. Persistent Issues (Current Status)
Despite the fixes pushed in commit `e49d4ba`:
- **UI Placeholder Persistence**: The "Market Intelligence Comparison" section frequently remains stuck on the *"Deep Intelligence Available"* placeholder even after a successful Brand Radar analysis of the primary company.
- **State Desync**: There appears to be a disconnect between the successful arrival of `BrandAnalysisData` and the rendering of the `ComparativeIntelligence` component.

## 4. Hypotheses for Next Steps
1. **Race Condition**: The `useEffect` in `Index.tsx` that syncs `insightsMap` with `intelligenceReports` might be firing before the `saveIntelligenceReport` call has finished updating the underlying state.
2. **Naming Case-Sensitivity**: While `.trim()` was added, the comparison might still be failing due to case differences (e.g., "Collinson Group" vs "COLLINSON GROUP").
3. **Array Dependency**: The `useEffect` intended to automatically select the primary company for insights might not be correctly identifying the first competitor in all scenarios.

---
**Architectural Decision:** Moved to a parallel analysis workflow to mimic local "simultaneous" performance; current blockers are likely timing-related within the React state lifecycle.
